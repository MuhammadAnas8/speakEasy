# Match your local Python
FROM python:3.8-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive

# System deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential curl git && \
    rm -rf /var/lib/apt/lists/*

# Rasa 3.6.x works with Python 3.8
RUN pip install --no-cache-dir "rasa==3.6.21"

WORKDIR /app

# IMPORTANT: Build context is already rasa_backend/, so copy files directly
COPY config.yml ./config.yml
COPY domain.yml ./domain.yml
COPY data ./data

# Train a tiny model at build time; name it consistently
RUN rasa train --fixed-model-name current-model

# Copy the rest (credentials, endpoints, etc.)
COPY . .

# Expose default port (Render passes $PORT at runtime)
EXPOSE 8000

# Run HTTP API with CORS; use $PORT if provided by platform

# Explicit host + port from $PORT, and point to the built model

CMD ["sh","-c","rasa run --enable-api --cors '*' --interface 0.0.0.0 --port ${PORT:-8000} --model models/current-model.tar.gz"]
