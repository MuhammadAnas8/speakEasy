# Use a stable Python for Rasa 3.x
FROM python:3.10-slim

# Faster, quieter installs
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive

# System deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential curl git && \
    rm -rf /var/lib/apt/lists/*

# Install Rasa (pin to a stable version)
# If you ever need the action server, we'll add rasa-sdk in that container.
RUN pip install --no-cache-dir "rasa==3.6.20"

# Workdir
WORKDIR /app

# Copy ONLY what we need for training first (better layer caching)
COPY rasa_backend/config.yml ./config.yml
COPY rasa_backend/domain.yml ./domain.yml
COPY rasa_backend/data ./data

# Train a fresh model from your data (small project = quick)
# We'll name it "current-model" so the runtime command can reference it consistently.
RUN rasa train --fixed-model-name current-model

# Copy remaining files (credentials, endpoints, etc.)
COPY rasa_backend/ ./

# Render will set $PORT at runtime; expose a default for local runs
EXPOSE 8000

# Run Rasa API server; allow CORS for now (we can tighten later)
# Use $PORT if provided by platform; otherwise default to 8000.
CMD sh -c 'rasa run --enable-api --cors "*" --port ${PORT:-8000} --model models/current-model.tar.gz'
